<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A==" crossorigin=""/>
    <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
    <style>
        body {
            margin: 0;
            padding: 0;
        }
        #map {
            width: 100%;
            height: 100vh;
        }
        #statusbar {
        	width: 100%;
			height: 20px;
			border: 1px solid black;
		} 
    </style>
</head>

<body>
	<input type="file" onchange="read(this)"/>
	<input id="trackgps" type="checkbox">Track GPS</input>
	<div id="statusbar">Status:</div>
    <div id="map"></div>
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js" integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA==" crossorigin=""></script>
    <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>
    <script>
    	var elemStatusbar = document.getElementById("statusbar");
    
    	//Setup the map
        var map_init = L.map('map', {center: [46.3, -79.4], zoom: 8});
        var osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'}).addTo(map_init);
        L.Control.geocoder().addTo(map_init);
        
        //Plot static blips
        var blips = [];
        var arrBlips = [];
        /*
		var arrBlips = blipsFakePositions({'lat':46.3,'long':-79.4});
        for (var i=0; i < arrBlips.length; i++) {
        	console.log("Plotting: " + arrBlips[i]['lat'] + ", " + arrBlips[i]['long']);
            blips[i] = L.circle([arrBlips[i]['lat'], arrBlips[i]['long']], {radius: 3.0, color: randomColor(), fillColor: randomColor(), opacity: 1.0, fillOpacity: 1.0}).addTo(map_init);
        };
		*/
        
        //Start tracking the GPS
        if (!navigator.geolocation) {
            console.log("Your browser doesn't support geolocation feature!")
        } else {
            setInterval(() => {navigator.geolocation.getCurrentPosition(getPosition, gpsError, {enableHighAccuracy: true})}, 3000);
        };
        function gpsError(err) {
   		console.warn(`Error: ${err.code}, ${err.message}`);
		};
		
		
		var dot, circle, lat, long, accuracy;
        function getPosition(position) {    
            lat = position.coords.latitude;
            long = position.coords.longitude;
            accuracy = (position.coords.accuracy/2);
				
            if (dot) {map_init.removeLayer(dot);};
			if (circle) {map_init.removeLayer(circle);};
            dot = L.circle([lat, long], {radius: 1.0, color: '#000000', opacity: 1.0, fillColor: '#FFFFFF', fillOpacity: 1});
            circle = L.circle([lat, long], {radius: accuracy, color: '#000000', opacity: 0.1, stroke: false});
            var featureGroup = L.featureGroup([dot, circle]).addTo(map_init);
			if (document.getElementById("trackgps").checked==true) {
           	map_init.fitBounds(featureGroup.getBounds());
			};
            elemStatusbar.innerHTML = "Lat:" + lat + " Long:" + long + " Acc:" + accuracy.toFixed(1);
        };
        
        
        
        function blipsFakePositions(position) {    
            var positionData = [];
		    for (var i=0; i < 30000; i++) {
				var newLong = position['long'] + ((Math.random() *.2)-.1);
				var newLat = position['lat'] + ((Math.random() *.2)-.1);
				
				positionData.push({'long':newLong, 'lat':newLat});	
			};
			return positionData;
        };
        function randomColor() {
        	return "#"+(((1+Math.random())*(1<<24)|0).toString(16)).substr(-6);
        };
        
        async function read(input) {
			arrBlips = JSON.parse(await readFile(input.files[0]));
			for (var i=0; i < arrBlips.length; i++) {
       		console.log("Plotting: " + arrBlips[i]['lat'] + ", " + arrBlips[i]['lng']);
           	blips[i] = L.circle([arrBlips[i]['lat'], arrBlips[i]['lng']], {radius: 3.0, color: randomColor(), fillColor: randomColor(), opacity: 1.0, fillOpacity: 1.0}).addTo(map_init);
     	  };
		}
        function readFile(file) {
			return new Promise((resolve, reject) => {
				let fr = new FileReader();
				fr.onload = x=> resolve(fr.result);
				fr.readAsText(file);
			});
		}
    </script>
</body>

</html>